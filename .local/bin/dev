
dev_path=~/Workspace/dotfiles/nixos/dev
shell_files=($(basename "$(pwd).nix") default.nix shell.nix)

function file_full_path() {
  echo "$(pwd)/$1"
}

function nearest_shell() {
  [ "$(pwd)" = "/" ] && exit 1

  if [ -z $1 ]; then
    for shell_file in ${shell_files[@]}; do
      file="$(file_full_path $shell_file)"

      [ -f "$file" ] && echo "$file" && exit 0
    done
  else
    file="$(file_full_path $1.nix)"

    [ -f "$file" ] && echo "$file" && exit 0
  fi


  cd ..

  echo "$(nearest_shell $1)"
}

function enter_shell() {
  if [ -f "$dev_path/$1.nix" ]; then
    shell_file="$dev_path/$1.nix"
  else
    shell_file="$(nearest_shell $1)"
  fi

  [ ! -f "$shell_file" ] && echo "No suitable shell file could be found!" && exit 1

  export NIXPKGS_ALLOW_UNFREE=1

  echo "Entering shell from: $shell_file"

  nix-shell --run "DEV_PROMPT=$dev_environment zsh" $shell_file
}

if [ ! -z $1 ]; then
  case $1 in
    create|init)
      [ -z "$2" ] && filename="shell.nix" || filename="$2.nix"

      echo -e "\nwith import <nixpkgs> { };\n\nmkShell {\n  buildInputs = [\n  ];\n}" > $filename
    ;;

    edit)
      [ -z "$2" ] && shell_file="$(nearest_shell)" || shell_file="$dev_path/$2.nix"

      [ ! -f "$shell_file" ] && echo "No suitable shell file could be found!" && exit 1

      ${EDITOR:-nvim} "$shell_file"
    ;;

    enter)
      [ -z $2 ] && exit 1

      dev_environment=$2

      enter_shell $2
    ;;

    *)
      dev_environment=$1

      enter_shell $1
    ;;
  esac
else
  dev_environment=$(basename $(pwd))

  enter_shell
fi
