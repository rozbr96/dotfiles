
dev_path=~/Workspace/dotfiles/nixos/dev
shell_files=(default.nix shell.nix)

function nearest_shell() {
  [ "$(pwd)" = "/" ] && exit 1

  for shell_file in ${shell_files[@]}; do
    file="$(pwd)/$shell_file"

    [ -f "$file" ] && echo "$file" && exit 0
  done

  cd ..

  echo "$(nearest_shell)"
}

function enter_shell() {
  if [ -z $1 ]; then
    shell_file="$(nearest_shell)"

    [ ! -f "$shell_file" ] && echo "No suitable shell.nix/default.nix file could be found!" && exit 1
  else
    shell_file="$HOME/Workspace/dotfiles/nixos/dev/$1.nix"
  fi

  echo "Entering shell from: $shell_file"

  nix-shell --run zsh $shell_file
}

if [ ! -z $1 ]; then
  case $1 in
    create|init)
      [ -z "$2" ] && filename="shell.nix" || filename="$2.nix"

      echo -e "\nwith import <nixpkgs> { };\n\nmkShell {\n  buildInputs = [\n  ];\n}" > $filename
    ;;

    edit)
      [ -z $2 ] && exit 1

      ${EDITOR:-nvim} "$dev_path/$2.nix"
    ;;

    enter)
      [ -z $2 ] && exit 1

      enter_shell $2
    ;;

    *)
      enter_shell $1
    ;;
  esac
else
  enter_shell
fi
